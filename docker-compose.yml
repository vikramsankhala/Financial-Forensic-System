version: "3.9"

services:
  db:
    image: timescale/timescaledb:latest-pg15
    command: postgres -c shared_preload_libraries=timescaledb
    environment:
      POSTGRES_DB: ffs
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - ffs_pgdata:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  neo4j:
    image: neo4j:5.15
    environment:
      NEO4J_AUTH: neo4j/fraud123
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data

  backend:
    build:
      context: ./backend
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@db:5432/ffs
      JWT_SECRET: ${JWT_SECRET:-local-dev-secret}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      REDIS_URL: redis://redis:6379/0
      REDIS_ENABLED: "true"
      NEO4J_URI: neo4j://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: fraud123
      NEO4J_ENABLED: "true"
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
      - neo4j

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://cardiac-realistic-thick-survivor.trycloudflare.com/api}
        NEXT_PUBLIC_DEMO_AUDIO_ENABLED: ${NEXT_PUBLIC_DEMO_AUDIO_ENABLED:-false}
        NEXT_PUBLIC_CONTROL_URL: ${NEXT_PUBLIC_CONTROL_URL:-https://municipality-suitable-vocational-ash.trycloudflare.com}
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://cardiac-realistic-thick-survivor.trycloudflare.com/api}
      NEXT_PUBLIC_DEMO_AUDIO_ENABLED: ${NEXT_PUBLIC_DEMO_AUDIO_ENABLED:-false}
      NEXT_PUBLIC_CONTROL_URL: ${NEXT_PUBLIC_CONTROL_URL:-https://municipality-suitable-vocational-ash.trycloudflare.com}
    ports:
      - "3000:3000"
    depends_on:
      - backend

  control:
    build:
      context: ./control
    environment:
      CONTROL_SERVICE_NAME: backend
      DOCKER_HOST: tcp://host.docker.internal:2375
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  ffs_pgdata:
  neo4j_data:
